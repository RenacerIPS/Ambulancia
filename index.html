<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambulancia Renacer IPS</title>
    <style>

        canvas {
        width: 100%;
        height: auto;
        max-width: 450px;
        aspect-ratio: 4 / 3;
        background-color: #fff;
        border: 2px solid #000;
        display: block;
        
        touch-action: none; /* evita scroll en iOS/Android mientras dibujas */
    }

        body {
            background-color: #121212;
            color: white;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            color: orange;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .tab {
            margin: 0 10px; /* Reducido el margen entre las pesta√±as */
            padding: 10px 20px;
            cursor: pointer;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 5px;
        }

        .tab:hover {
            background-color: #555;
        }

        .content {
            display: none;
            margin-top: 30px;
            text-align: center;
        }

        .active-tab {
            display: block;
        }

        h2 {
            color: orange;  /* Color naranja para los subt√≠tulos */
        }

        form {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: white;
            text-align: left;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            min-height: 40px;   /* üëà agrega esta l√≠nea */
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #222;
            color: white;
            display: block;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
        }


        button {
            background-color: orange;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        button:hover {
            background-color: #e87e01;
        }

        @media (max-width: 600px) {
            form {
                width: 95%;
            }

            .tabs {
                flex-direction: column;
                margin-top: 10px;
            }

            .tab {
                margin: 5px 0;
            }
        }

        .contenedor-opciones {
            display: flex; /* Flexbox para alinear los elementos en l√≠nea */
            gap: 10px; /* Espacio entre los elementos */
            justify-content: space-between; /* Alinea los elementos con espacio entre ellos */
            width: 95%; /* Asegura que ocupe todo el ancho disponible */
        }

        .contenedor-opciones input, 
        .contenedor-opciones select {
            flex: 1; /* Proporci√≥n de la primera columna */
        }

        .contenedor-opciones input:nth-child(2), 
        .contenedor-opciones select:nth-child(2) {
            flex: 1.5; /* Proporci√≥n de la segunda columna */
        }

        .contenedor-opciones input:nth-child(3), 
        .contenedor-opciones select:nth-child(3) {
            flex: 1.5; /* Proporci√≥n de la tercera columna */
        }
        .contenedor-botones {
            display: flex; /* Flexbox para alinear los elementos en l√≠nea */
            gap: 10px; /* Espacio entre los botones */
            justify-content: space-between; /* Espacio entre los controles */
            width: 44%; /* El contenedor no ocupa todo el ancho de la p√°gina */
            margin: 0 auto; /* Centra el contenedor */
        }

        input[type="color"] {
      -webkit-appearance: none; /* Elimina la apariencia predeterminada del navegador */
      width: 50px; /* Puedes ajustar el ancho */
      height: 50px; /* Aqu√≠ puedes cambiar la altura */
      border:none; /* Si no quieres bordes */
      padding: 5; /* Elimina cualquier espacio interno */
    }


        /* üîπ Ajuste espec√≠fico para campos de fecha y listas */
        select,
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            height: 40px;          /* altura uniforme   */
            padding: 8px;          /* espaciado interno */
            line-height: 1.2;
            box-sizing: border-box; /* üëà asegura mismo c√°lculo de ancho */
            -webkit-appearance: none; /* quita estilo nativo WebKit */
            -moz-appearance: none;    /* quita estilo nativo Firefox */
            appearance: none;         /* quita estilo nativo est√°ndar */
        }

    </style>
</head>
<body>
    <h1>Ambulancia Renacer IPSA</h1>

    <div class="tabs">
        <div class="tab" onclick="showContent('registro-pacientes')">Registro de pacientes</div>
        <div class="tab" onclick="showContent('registro-traslados')">Registro de traslados</div>
        <div class="tab" onclick="showContent('registro-firmas')">Registro de firmas</div>
    </div>

    <div id="registro-pacientes" class="content">
        <h2>Registro de pacientes</h2>

        <form id="registroForm">
            
            <label for="primernombre">Primer Nombre</label>
            <input type="text" id="primernombre" name="primernombre" required>
            
            <label for="segundonombre">Segundo Nombre</label>
            <input type="text" id="segundonombre" name="segundonombre">
            
            <label for="primerapellido">Primer Apellido</label>
            <input type="text" id="primerapellido" name="primerapellido" required>
            
            <label for="segundoapellido">Segundo Apellido</label>
            <input type="text" id="segundoapellido" name="segundoapellido">

            <label for="tipoDocumento">Tipo de documento</label>
            <select id="tipoDocumento" name="tipoDocumento" required>

                <option value="RC">RC - Registro Civil</option>
                <option value="TI">TI - Tarjeta de Identidad</option>
                <option value="CC">CC - C√©dula de Ciudadan√≠a</option>
                <option value="CE">CE - C√©dula de extranjer√≠a</option>
                <option value="PA">PA - Pasaporte</option>
                <option value="CD">CD - Carn√© Diplom√°tico</option>
                <option value="DE">DE - Documento extranjero</option>
                <option value="SC">SC - Salvoconducto</option>
                <option value="PE">PE - Permiso Especial de Permanencia)</option>

            </select>

            <label for="numeroDocumento">N√∫mero de documento</label>
            <input type="number" id="numeroDocumento" name="numeroDocumento" required>

            <label for="genero">G√©nero</label>
            <select id="genero" name="genero" required>
                <option value="Masculino">Masculino</option>
                <option value="Femenino">Femenino</option>
            </select>

            <label for="fechaNacimiento">Fecha de nacimiento</label>
            <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>

            <label for="lugarNacimiento">Lugar de nacimiento</label>
            <input type="file" id="archivoColombia" accept=".mdbx" />
    
            <!-- Select para Departamento de Nacimiento -->
            <label for="departamentosNacimiento">Departamento de Nacimiento:</label>
            <select id="departamentosNacimiento" name="departamentosNacimiento" required>
                <option value="">Seleccione un Departamento</option>
            </select>
        
            <!-- Select para Municipio de Nacimiento -->
            <label for="municipiosNacimiento">Municipio de Nacimiento:</label>
            <select id="municipiosNacimiento" name="municipiosNacimiento" required>
                <option value="">Seleccione un Municipio</option>
            </select>

            <label for="aseguradora">Aseguradora</label>
            <input type="text" id="aseguradora" name="aseguradora" required>

             <!-- Select para Departamento de Residencia -->
            <label for="departamentosResidencia">Departamento de Residencia:</label>
            <select id="departamentosResidencia" name="departamentosResidencia" required>
                <option value="">Seleccione un Departamento</option>
            </select>

            <!-- Select para Municipio de Residencia -->
            <label for="municipiosResidencia">Municipio de Residencia:</label>
            <select id="municipiosResidencia" name="municipiosResidencia" required>
                <option value="">Seleccione un Municipio</option>
            </select>

            <label for="direccion">Direcci√≥n</label>
            <input type="text" id="direccion" name="direccion" required>

            <label for="telefono">Tel√©fono</label>
            <input type="number" id="telefono" name="telefono" required>

            <button type="submit">Guardar</button>
        </form>
    </div>

    <div id="registro-traslados" class="content">
        <h2>Registro de traslados</h2>

        <form id="trasladoForm">
            <label for="numeroTraslado">N√∫mero traslado</label>
            <input type="number" id="numeroTraslado" name="numeroTraslado" required>

            <label for="fechaHoraDespacho">Fecha y hora de despacho</label>
            <input type="datetime-local" id="fechaHoraDespacho" name="fechaHoraDespacho" required>

            <label for="triaje">Triaje</label>
            <select id="triaje" name="triaje" required>
                <option value="Triage I (Rojo)">Triage I (Rojo): Atenci√≥n inmediata.</option>
                <option value="Triage II (Naranja)">Triage II (Naranja): Atenci√≥n urgente.</option>
                <option value="Triage III (Amarillo)">Triage III (Amarillo): Atenci√≥n diferida.</option>
                <option value="Triage IV (Verde)">Triage IV (Verde): Atenci√≥n ambulatoria o referida a otro servicio.</option>
                <option value="Triage V (Azul)">Triage V (Azul): No requiere atenci√≥n m√©dica urgente.</option>
            </select>

            <label for="fechaHoraLlegadaOrigen">Fecha y hora de llegada al origen</label>
            <input type="datetime-local" id="fechaHoraLlegadaOrigen" name="fechaHoraLlegadaOrigen" required>

            <label for="origen">Origen</label>
            <input type="text" id="origen" name="origen" required>

            <label for="fechaHoraSalidaOrigen">Fecha y hora de salida origen</label>
            <input type="datetime-local" id="fechaHoraSalidaOrigen" name="fechaHoraSalidaOrigen" required>

            <label for="fechaHoraLlegadaUno">Fecha y hora de llegada (Destino uno)</label>
            <input type="datetime-local" id="fechaHoraLlegadaUno" name="fechaHoraLlegadaUno" required>

            <label for="destinoUno">Destino uno</label>
            <input type="text" id="destinoUno" name="destinoUno" required>

            <label for="fechaHoraSalidaUno">Fecha y hora de salida (Destino uno)</label>
            <input type="datetime-local" id="fechaHoraSalidaUno" name="fechaHoraSalidaUno" required>


            <label for="fechaHoraLlegadaDos">Fecha y hora de llegada (Destino dos)</label>
            <input type="datetime-local" id="fechaHoraLlegadaDos" name="fechaHoraLlegadaDos">

            <label for="destinoDos">Destino dos</label>
            <input type="text" id="destinoDos" name="destinoDos">

            <label for="fechaHoraSalidaDos">Fecha y hora de salida (Destino dos)</label>
            <input type="datetime-local" id="fechaHoraSalidaDos" name="fechaHoraSalidaDos">

            <label for="motivoTraslado">Motivo de traslado</label>
            <input type="text" id="motivoTraslado" name="motivoTraslado" required>

            <label for="medicoTraslado">M√©dico de traslado</label>
            <input type="text" id="medicoTraslado" name="medicoTraslado">

            <label for="enfermeraTraslado">Enfermera de traslado</label>
            <input type="text" id="enfermeraTraslado" name="enfermeraTraslado" required>

            <label for="conductorTraslado">Conductor de traslado</label>
            <input type="text" id="conductorTraslado" name="conductorTraslado" required>

            <label for="profesionalEntrega">Profesional que entrega</label>
            <input type="text" id="profesionalEntrega" name="profesionalEntrega" required>

            <label for="profesionalRecibeUno">Profesional que recibe destino uno</label>
            <input type="text" id="profesionalRecibeUno" name="profesionalRecibeUno" required>

            <label for="profesionalRecibeDos">Profesional que recibe destino dos</label>
            <input type="text" id="profesionalRecibeDos" name="profesionalRecibeDos">

            <label for="nombreAcompa√±ante">Nombre del acompa√±ante</label>
            <input type="text" id="nombreAcompa√±ante" name="nombreAcompa√±ante" required>
    
            <label for="telefonoAcompa√±ante">Tel√©fono del acompa√±ante</label>
            <input type="number" id="telefonoAcompa√±ante" name="telefonoAcompa√±ante" required>

            <label for="notasTraslado">Notas de traslado</label>
            <textarea id="notasTraslado" name="notasTraslado" rows="8" placeholder="Ingrese las notas del traslado..." required></textarea>

            <button type="submit">Guardar</button>
        </form>
    </div>

    <div id="registro-firmas" class="content">
        <h2>Registro de firmas</h2>
      
        <form id="firmaForm">
          <label for="numeroTrasladoFirma">N√∫mero traslado</label>
          <input type="number" id="numeroTrasladoFirma" name="numeroTraslado" required>
      
          <label for="nombreFirma">Tipo de firma</label>
          <select id="nombreFirma" name="nombreFirma" class="boton">
            <option value="Firma Paciente">Firma Paciente</option>
            <option value="Firma entrega">Firma entrega</option>
            <option value="Firma recibe 1">Firma recibe 1</option>
            <option value="Firma recibe 2">Firma recibe 2</option>
          </select>
      
          <label for="pizarra">√Årea de firma</label>
          <canvas id="pizarra" width="450" height="337"></canvas>

      
          <label for="colorTinta">Color de tinta</label>
          <input type="color" id="colorTinta" name="colorTinta" class="boton" value="#000000">
      
          <label for="grosorLapiz">Grosor del l√°piz</label>
          <input type="range" id="grosorLapiz" name="grosorLapiz" class="boton" min="1" max="20" value="3">
      
          <div class="contenedor-botones">
            <button type="button" id="limpiar" class="boton">Limpiar</button>
            <button type="button" id="guardar" class="boton">Guardar</button>
          </div>
        </form>
      </div>


      <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>


    <script>

        window.addEventListener("beforeunload", function (e) {
            // Muestra un mensaje del navegador
            e.preventDefault();
            e.returnValue = "";
        });

        let departamentosData = [];  // Para almacenar los departamentos √∫nicos
        let municipiosData = [];     // Para almacenar todos los municipios
        let departamentosMunicipios = {};  // Relacionar departamentos con municipios

        // Funci√≥n para cargar el archivo TablaColombia.mdbx
        document.getElementById("archivoColombia").addEventListener("change", function(event) {
            const archivo = event.target.files[0];
            if (archivo) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const data = e.target.result;

                    // Separar los datos por l√≠neas
                    const lineas = data.trim().split('\n');
                    const selectDepartamentosNacimiento = document.getElementById("departamentosNacimiento");
                    const selectDepartamentosResidencia = document.getElementById("departamentosResidencia");

                    // Limpiar los departamentos y municipios anteriores
                    departamentosData = [];
                    municipiosData = [];
                    departamentosMunicipios = {}; // Limpiar la relaci√≥n

                    // A√±adir el primer valor para seleccionar un departamento
                    selectDepartamentosNacimiento.innerHTML = '<option value="">Seleccione un Departamento</option>';
                    selectDepartamentosResidencia.innerHTML = '<option value="">Seleccione un Departamento</option>';

                    // Iterar sobre cada l√≠nea y separar las columnas
                    lineas.forEach(linea => {
                        const [codigoDepto, nombreDepto, codigoMunicipio, nombreMunicipio] = linea.split('|');

                        if (codigoDepto && nombreDepto && codigoMunicipio && nombreMunicipio) {
                            // Agregar el municipio a la lista de municipios
                            municipiosData.push({ codigoDepto, codigoMunicipio, nombreMunicipio });

                            // Relacionar el municipio con su departamento
                            if (!departamentosMunicipios[codigoDepto]) {
                                departamentosMunicipios[codigoDepto] = [];
                            }
                            departamentosMunicipios[codigoDepto].push({ codigoMunicipio, nombreMunicipio });

                            // Agregar el departamento solo si no est√° agregado ya
                            if (!departamentosData.some(depto => depto.codigo === codigoDepto)) {
                                departamentosData.push({ codigo: codigoDepto, nombre: nombreDepto });

                                // Crear el <option> para el departamento de nacimiento
                                const optionNacimiento = document.createElement("option");
                                optionNacimiento.value = codigoDepto.trim();  // Usamos el c√≥digo del departamento
                                optionNacimiento.textContent = nombreDepto.trim();  // Nombre del departamento
                                selectDepartamentosNacimiento.appendChild(optionNacimiento);

                                // Crear el <option> para el departamento de residencia
                                const optionResidencia = document.createElement("option");
                                optionResidencia.value = codigoDepto.trim();  // Usamos el c√≥digo del departamento
                                optionResidencia.textContent = nombreDepto.trim();  // Nombre del departamento
                                selectDepartamentosResidencia.appendChild(optionResidencia);
                            }
                        }
                    });

                    console.log("Departamentos √∫nicos:", departamentosData);
                    console.log("Municipios cargados:", municipiosData);
                    console.log("Departamentos relacionados con municipios:", departamentosMunicipios);
                };

                // Leer el archivo como texto
                reader.readAsText(archivo);
            } else {
                console.error("No se seleccion√≥ ning√∫n archivo.");
            }
        });

        // Funci√≥n para manejar el cambio de selecci√≥n de departamento de nacimiento
        document.getElementById("departamentosNacimiento").addEventListener("change", function() {
            const codigoDepartamentoSeleccionado = this.value;
            cargarMunicipios(codigoDepartamentoSeleccionado, 'Nacimiento');
        });

        // Funci√≥n para manejar el cambio de selecci√≥n de departamento de residencia
        document.getElementById("departamentosResidencia").addEventListener("change", function() {
            const codigoDepartamentoSeleccionado = this.value;
            cargarMunicipios(codigoDepartamentoSeleccionado, 'Residencia');
        });

        // Funci√≥n para cargar los municipios correspondientes al departamento seleccionado
        function cargarMunicipios(codigoDepartamentoSeleccionado, tipo) {
            let selectMunicipios;
            if (tipo === 'Nacimiento') {
                selectMunicipios = document.getElementById("municipiosNacimiento");
            } else if (tipo === 'Residencia') {
                selectMunicipios = document.getElementById("municipiosResidencia");
            }

            // Limpiar el <select> de municipios
            selectMunicipios.innerHTML = '<option value="">Seleccione un Municipio</option>';

            // Filtrar los municipios por departamento
            const municipiosFiltrados = departamentosMunicipios[codigoDepartamentoSeleccionado];

            // Verificar si se encontraron municipios
            if (municipiosFiltrados && municipiosFiltrados.length > 0) {
                municipiosFiltrados.forEach(municipio => {
                    const option = document.createElement("option");
                    option.value = municipio.codigoMunicipio;
                    option.textContent = municipio.nombreMunicipio;
                    selectMunicipios.appendChild(option);
                });
            } else {
                // Si no se encuentran municipios, agregar una opci√≥n de "No hay municipios"
                const option = document.createElement("option");
                option.disabled = true;
                option.textContent = "No hay municipios para este departamento";
                selectMunicipios.appendChild(option);
            }
        }

            let miCanvas = document.querySelector('#pizarra');
            let lineas = [];
            let pintarLinea = false;
            let nuevaPosicionX = 0;
            let nuevaPosicionY = 0;
            let colorLapiz = "#000000";
            let grosorLapiz = 3;

            // Funci√≥n para ajustar el tama√±o del canvas y redibujar las l√≠neas
            function ajustarCanvas() {
                const rect = miCanvas.getBoundingClientRect();
                const prevWidth = miCanvas.width;
                const prevHeight = miCanvas.height;

                const dpr = window.devicePixelRatio || 1;
                miCanvas.width = rect.width * dpr;
                miCanvas.height = rect.height * dpr;
                const ctx = miCanvas.getContext('2d');
                ctx.scale(dpr, dpr);

                // Redibujar l√≠neas escaladas si ya existen
                if (lineas.length > 0 && prevWidth && prevHeight) {
                    const escalaX = miCanvas.width / prevWidth;
                    const escalaY = miCanvas.height / prevHeight;

                    lineas = lineas.map(segmento =>
                        segmento.map(punto => ({
                            x: punto.x * escalaX,
                            y: punto.y * escalaY
                        }))
                    );

                    dibujarTodo();
                }
            }

            // Redibuja todas las l√≠neas guardadas
            function dibujarTodo() {
                const ctx = miCanvas.getContext('2d');
                ctx.clearRect(0, 0, miCanvas.width, miCanvas.height);
                ctx.lineJoin = ctx.lineCap = 'round';
                ctx.lineWidth = grosorLapiz;
                ctx.strokeStyle = colorLapiz;

                ctx.beginPath();
                lineas.forEach(segmento => {
                    ctx.moveTo(segmento[0].x, segmento[0].y);
                    segmento.forEach(punto => {
                        ctx.lineTo(punto.x, punto.y);
                    });
                });
                ctx.stroke();
            }

            // Inicializar canvas
            ajustarCanvas();
            window.addEventListener('resize', ajustarCanvas);
            window.addEventListener('load', ajustarCanvas);

            // Clase para guardar imagen
            // Clase para guardar imagen (compatible iOS / Android)
            class GuardarImagen {
                constructor(canvas) {
                    this.canvas = canvas;
                }

                guardar(nombre) {
                    // ‚úÖ Convertir el canvas a Blob (mejor compatibilidad)
                    this.canvas.toBlob(blob => {
                        if (!blob) return;

                        // ‚úÖ Nombre del archivo
                        const fileName = `${nombre}.png`;

                        // ‚úÖ Guardar con FileSaver.js (funciona en iOS/Android)
                        saveAs(blob, fileName);
                    }, 'image/png');
                }
            }

            const guardarImagen = new GuardarImagen(miCanvas);

            // Eventos de dibujo
            function empezarDibujo(e) {
                e.preventDefault();
                pintarLinea = true;
                lineas.push([]);
            }

            function guardarLinea() {
                lineas[lineas.length - 1].push({
                    x: nuevaPosicionX,
                    y: nuevaPosicionY
                });
            }

            function dibujarLinea(event) {
                event.preventDefault();
                event.preventDefault();
                if (!pintarLinea) return;

                const rect = miCanvas.getBoundingClientRect();

                if (event.changedTouches == undefined) {
                    nuevaPosicionX = event.clientX - rect.left;
                    nuevaPosicionY = event.clientY - rect.top;
                } else {
                    nuevaPosicionX = event.changedTouches[0].clientX - rect.left;
                    nuevaPosicionY = event.changedTouches[0].clientY - rect.top;
                }

                guardarLinea();
                dibujarTodo();
            }

            function pararDibujar() {
                pintarLinea = false;
                guardarLinea();
            }

            function limpiarCanvas() {
                const ctx = miCanvas.getContext('2d');
                ctx.clearRect(0, 0, miCanvas.width, miCanvas.height);
                lineas = [];
            }

            // Eventos del canvas (Pointer Events unificados)
            miCanvas.addEventListener('pointerdown', empezarDibujo, false);
            miCanvas.addEventListener('pointermove', dibujarLinea, false);
            miCanvas.addEventListener('pointerup', pararDibujar, false);
            miCanvas.addEventListener('pointerleave', pararDibujar, false);

            // Controles
            document.querySelector('#limpiar').addEventListener('click', limpiarCanvas);
            document.querySelector('#colorTinta').addEventListener('input', e => colorLapiz = e.target.value);
            document.querySelector('#grosorLapiz').addEventListener('input', e => grosorLapiz = e.target.value);


// ‚úÖ Evento de guardar con validaci√≥n
document.querySelector('#guardar').addEventListener('click', () => {
    const nombreFirma = document.querySelector('#nombreFirma').value.trim();
    const numeroDocumentoFirma = document.querySelector('#numeroTrasladoFirma').value.trim();

    // ‚úÖ Validar que el n√∫mero de traslado no est√© vac√≠o
    if (!numeroDocumentoFirma) {
        alert('Por favor, ingresa el n√∫mero de traslado antes de guardar.');
        return; // Detiene la ejecuci√≥n si no hay n√∫mero
    }

    // ‚úÖ Si el nombre est√° vac√≠o, solo se usar√° el n√∫mero
    const nombreArchivo = nombreFirma
        ? `${nombreFirma}-${numeroDocumentoFirma}`
        : `Traslado-${numeroDocumentoFirma}`;

    guardarImagen.guardar(nombreArchivo);
});
      
        function showContent(tabId) {
            const contents = document.querySelectorAll('.content');
            contents.forEach(content => {
                content.classList.remove('active-tab');
            });
            const selectedTab = document.getElementById(tabId);
            selectedTab.classList.add('active-tab');
        }

        showContent('registro-pacientes');

        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year}-${hours}:${minutes}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const currentDateTime = getCurrentDateTime();
            document.getElementById('fechaHoraSalida').value = currentDateTime;
            document.getElementById('fechaHoraLlegadaUno').value = currentDateTime;
            document.getElementById('fechaHoraLlegadaDos').value = currentDateTime;
        });


        document.getElementById('registroForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            
                const departamentoNacimiento = document.getElementById("departamentosNacimiento").value;
                const municipioNacimiento = document.getElementById("municipiosNacimiento").value;
                const departamentoResidencia = document.getElementById("departamentosResidencia").value;
                const municipioResidencia = document.getElementById("municipiosResidencia").value;

            const csvContent = [
                ['Primer Nombre','Segundo Nombre','Primer Apellido','Segundo Apellido', 'Tipo Documento', 'N√∫mero Documento', 'G√©nero', 'Fecha Nacimiento', 'Departamento Nacimiento', 'Municipio Nacimiento', 'Aseguradora', 'Departamento Residencia', 'Municipio Residencia','Direcci√≥n', 'Tel√©fono'],
                [ data.primernombre ,data.segundonombre,data.primerapellido,data.segundoapellido, data.tipoDocumento, data.numeroDocumento, data.genero, data.fechaNacimiento,departamentoNacimiento,municipioNacimiento, data.aseguradora, departamentoResidencia, municipioResidencia, data.direccion, data.telefono]
            ];

            const csvRows = csvContent.map(row => row.join(',')).join('\n');

            // ‚úÖ Solo UNA vez se define el blob, ahora con charset utf-8
            const blob = new Blob([csvRows], { type: 'text/csv;charset=utf-8' });

            // ‚úÖ Solo UNA vez se define el nombre del archivo
            const numeroDocumento = data.numeroDocumento || 'desconocido';
            const fileName = `Paciente-${numeroDocumento}.csv`;

            // ‚úÖ FileSaver.js reemplaza las 4 l√≠neas antiguas
            saveAs(blob, fileName);

            alert('¬°Datos del paciente guardados correctamente en la base de datos!');
        });

        document.getElementById('trasladoForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            const csvContent = [
                ['N√∫mero traslado','Fecha y hora de despacho','Triaje','Fecha y hora de llegada al origen','Origen','Fecha y hora de salida origen','Fecha y hora de llegada (Destino uno)','Destino uno','Fecha y hora de salida (Destino uno)','Fecha y hora de llegada (Destino dos)','Destino dos','Fecha y hora de salida (Destino dos)','Motivo de traslado','M√©dico de traslado','Enfermera de traslado','Conductor de traslado','Profesional que entrega','Profesional que recibe destino uno','Profesional que recibe destino dos','Nombre del acompa√±ante','Tel√©fono del acompa√±ante','Notas de traslado'],
                [ data.numeroTraslado,data.fechaHoraDespacho,data.triaje,data.fechaHoraLlegadaOrigen,data.origen,data.fechaHoraSalidaOrigen,data.fechaHoraLlegadaUno,data.destinoUno,data.fechaHoraSalidaUno,data.fechaHoraLlegadaDos,data.destinoDos,data.fechaHoraSalidaDos,data.motivoTraslado,data.medicoTraslado,data.enfermeraTraslado,data.conductorTraslado,data.profesionalEntrega,data.profesionalRecibeUno,data.profesionalRecibeDos,data.nombreAcompa√±ante,data.telefonoAcompa√±ante,data.notasTraslado]
            ];

            const csvRows = csvContent.map(row => row.join(',')).join('\n');

            // ‚úÖ Solo UNA vez se define el blob, con charset utf-8 para acentos
            const blob = new Blob([csvRows], { type: 'text/csv;charset=utf-8' });

            // ‚úÖ Solo UNA vez se define el nombre del archivo
            const numeroTraslado = data.numeroTraslado || 'desconocido';
            const fileName = `Traslado-${numeroTraslado}.csv`;

            // ‚úÖ FileSaver.js inicia la descarga/compartir
            saveAs(blob, fileName);

            alert('¬°Datos del traslado guardados correctamente en la base de datos!');
        });
    </script>
</body>
</html>
